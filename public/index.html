<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="page-title">502 Bad Gateway</title>
    <style>
        /* Общие стили для BODY - они всегда будут одинаковыми, как в исходной панели скриншотов */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px; /* Исходный padding 20px со всех сторон */
            line-height: 1.6;
            display: flex;
            justify-content: center; /* Центрирует основные контейнеры по горизонтали */
            align-items: flex-start; /* Размещает основные контейнеры сверху по вертикали */
            min-height: 100vh; /* Минимальная высота на весь экран */
            box-sizing: border-box; /* Учитывает padding в общей ширине/высоте */
            /* Начальные цвета body - для страницы ошибки */
            background-color: #000;
            color: #fff;
            transition: background-color 0.3s ease, color 0.3s ease; /* Плавный переход */
        }

        /* КОНТЕЙНЕРЫ ДЛЯ СТРАНИЦ - каждый будет иметь свой display */
        #error-page-container,
        #screenshot-panel-container {
            width: 100%;
            max-width: 1200px; /* Оба контейнера ограничены 1200px ширины */
            box-sizing: border-box;
            /* Flex-grow позволит им занимать доступное пространство, если нужно */
            flex-grow: 1;
        }

        /* Стили для содержимого страницы 502 Bad Gateway */
        #error-page-content {
            display: flex; /* Делаем содержимое страницы ошибки flex-контейнером */
            flex-direction: column;
            justify-content: center; /* Центрируем содержимое по вертикали внутри себя */
            align-items: center; /* Центрируем содержимое по горизонтали внутри себя */
            min-height: calc(100vh - 40px); /* Высота на весь экран минус padding body */
            text-align: center;
            background-color: #000; /* Фон для содержимого ошибки */
            color: #fff; /* Цвет текста для содержимого ошибки */
        }
        #error-page-content .error-code {
            font-size: 8em;
            font-weight: bold;
            margin-bottom: 10px;
        }
        #error-page-content .error-message {
            font-size: 2em;
            margin-bottom: 30px;
        }
        /* Стили для незаметной ссылки "Bad" */
        #error-page-content .link.invisible-link {
            color: inherit; /* Цвет текста будет таким же, как у родителя */
            text-decoration: none; /* Убираем подчеркивание */
            cursor: pointer; /* Курсор все еще будет указывать на кликабельность */
        }
        #error-page-content .link.invisible-link:hover {
            text-decoration: none; /* Убираем подчеркивание при наведении */
            color: inherit; /* Цвет остается таким же */
        }

        #error-page-content .request-id {
            font-size: 1.2em;
            margin-bottom: 20px;
            color: #aaa;
        }
        #error-page-content .info-text {
            font-size: 1em;
            margin-bottom: 10px;
        }
        /* Стандартные ссылки на странице ошибки, чтобы они оставались синими и подчеркнутыми */
        #error-page-content .info-text .link {
            color: #007bff;
            text-decoration: none;
        }
        #error-page-content .info-text .link:hover {
            text-decoration: underline;
        }
        #error-page-content .powered-by {
            margin-top: 20px;
            font-size: 0.9em;
            color: #777;
        }

        /* Стили для панели скриншотов (полностью ваши исходные стили) */
        #screenshot-panel-content {
            /* Этот контейнер будет виден как block или flex, в зависимости от логики */
            background-color: #f0f2f5; /* Фон для панели скриншотов */
            color: #333; /* Цвет текста для панели скриншотов */
        }
        #screenshot-panel-content .header-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }
        #screenshot-panel-content .header-container h1 {
            margin: 0;
            flex-grow: 1;
            text-align: center;
        }
        #screenshot-panel-content button {
            background-color: #007bff;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1em;
            transition: background-color 0.2s ease;
        }
        #screenshot-panel-content button:hover {
            background-color: #0056b3;
        }
        #screenshot-panel-content input[type="text"],
        #screenshot-panel-content textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 1em;
            box-sizing: border-box;
        }

        #screenshot-panel-content #screenshots-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 25px;
            margin-top: 20px;
        }
        #screenshot-panel-content .screenshot-item {
            background-color: white;
            border: 1px solid #e0e0e0;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        #screenshot-panel-content .screenshot-item h3 {
            font-size: 1.2em;
            margin-top: 0;
            margin-bottom: 15px;
            color: #4a69bd;
            border-bottom: 1px solid #f0f0f0;
            padding-bottom: 10px;
        }
        #screenshot-panel-content .screenshot-item img {
            max-width: 100%;
            height: auto;
            border: 1px solid #f5f5f5;
            border-radius: 5px;
            margin-bottom: 15px;
            object-fit: contain;
            background-color: #fff;
        }
        #screenshot-panel-content .screenshot-item .answer-display {
            margin-top: 15px;
            padding: 12px;
            background-color: #e9f5ff;
            border-left: 4px solid #007bff;
            font-size: 0.95em;
            color: #333;
            border-radius: 5px;
            min-height: 3em;
            display: flex;
            align-items: center;
        }
        #screenshot-panel-content .screenshot-item textarea {
            margin-top: 15px;
            min-height: 60px;
        }
        #screenshot-panel-content .screenshot-item .action-buttons {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        #screenshot-panel-content .screenshot-item .action-buttons button {
            flex-grow: 1;
        }
        #screenshot-panel-content .screenshot-item .delete-button {
            background-color: #dc3545;
        }
        #screenshot-panel-content .screenshot-item .delete-button:hover {
            background-color: #c82333;
        }
        #screenshot-panel-content .no-screenshots {
            text-align: center;
            grid-column: 1 / -1;
            font-size: 1.2em;
            color: #777;
            padding: 50px;
        }
    </style>
</head>
<body>

    <div id="error-page-container">
        <div id="error-page-content">
            <div class="error-code">502</div>
            <div class="error-message">
                <a href="#" class="link invisible-link" id="bad-gateway-link">Bad</a> Gateway
            </div>
            <div class="request-id">Request ID: 95fb249e39e5c6d9-PDX</div>
            <div class="info-text">Этот сервис в настоящее время недоступен. Пожалуйста, попробуйте снова через несколько минут.</div>
            <div class="info-text">Если вы являетесь владельцем сайта, обратитесь к <a href="https://render.com/docs" class="link">документации Render</a> для устранения неполадок.</div>
            <div class="powered-by">Powered by Render</div>
        </div>
    </div>

    <div id="screenshot-panel-container">
        <div id="screenshot-panel-content">
            <div class="header-container">
                <h1>Панель скриншотов</h1>
                <button id="clearAllScreenshots">Очистить все (с этой страницы)</button>
            </div>
            <div id="screenshots-container">
                <p class="no-screenshots" id="no-screenshots-message">Ожидание скриншотов...</p>
            </div>
        </div>
    </div>

    <script>
        const errorPageContainer = document.getElementById('error-page-container');
        const screenshotPanelContainer = document.getElementById('screenshot-panel-container');
        const badGatewayLink = document.getElementById('bad-gateway-link');
        const pageTitle = document.getElementById('page-title');

        // Элементы панели скриншотов (перенесены из #main-app-container в #screenshot-panel-content)
        const screenshotsContainer = document.getElementById('screenshots-container');
        let noScreenshotsMessage = document.getElementById('no-screenshots-message');
        const clearAllScreenshotsButton = document.getElementById('clearAllScreenshots');

        let ws;
        const localScreenshotsData = new Map();

        // Функция для переключения между страницами
        function showPage(pageName) {
            if (pageName === 'error') {
                errorPageContainer.style.display = 'flex'; // Контейнер ошибки виден
                screenshotPanelContainer.style.display = 'none'; // Контейнер панели скрыт
                document.body.style.backgroundColor = '#000'; // Фон body для ошибки
                document.body.style.color = '#fff'; // Цвет текста body для ошибки
                pageTitle.textContent = '502 Bad Gateway';
            } else if (pageName === 'screenshot_panel') {
                errorPageContainer.style.display = 'none'; // Контейнер ошибки скрыт
                screenshotPanelContainer.style.display = 'block'; // Контейнер панели виден (или flex, если внутри есть flex-элементы)
                document.body.style.backgroundColor = '#f0f2f5'; // Фон body для панели
                document.body.style.color = '#333'; // Цвет текста body для панели
                pageTitle.textContent = 'Панель скриншотов';
                if (!ws || ws.readyState === WebSocket.CLOSED) {
                    initWebSocket();
                }
                checkNoScreenshots();
            }
        }

        // Обработчик нажатия на ссылку "Bad"
        badGatewayLink.addEventListener('click', (event) => {
            event.preventDefault(); // Предотвращаем перезагрузку страницы
            showPage('screenshot_panel');
        });

        // WebSocket функции (ваш исходный код, без изменений)
        function initWebSocket() {
            const protocol = location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${protocol}//${location.host}`;
            ws = new WebSocket(wsUrl);

            ws.onopen = () => {
                console.log('Frontend: WebSocket подключен');
                ws.send(JSON.stringify({ type: 'frontend_connect' }));
            };

            ws.onmessage = (event) => {
                const data = JSON.parse(event.data);
                console.log('Frontend: Получено сообщение:', data);

                if (data.type === 'screenshot_info') {
                    localScreenshotsData.set(data.questionId, data);
                    addOrUpdateScreenshot(data.questionId, data.imageUrl, data.answer);
                    if (noScreenshotsMessage) {
                        noScreenshotsMessage.style.display = 'none';
                    }
                } else if (data.type === 'answer') {
                    const ss = localScreenshotsData.get(data.questionId);
                    if (ss) {
                        ss.answer = data.answer;
                    }
                    updateAnswer(data.questionId, data.answer);
                } else if (data.type === 'screenshot_deleted_specific') {
                    localScreenshotsData.delete(data.questionId);
                    const item = document.querySelector(`.screenshot-item[data-question-id="${data.questionId}"]`);
                    if (item) {
                        item.remove();
                        checkNoScreenshots();
                    }
                }
            };

            ws.onclose = () => {
                console.log('Frontend: WebSocket отключен. Попытка переподключения через 5 секунд...');
                setTimeout(initWebSocket, 5000);
            };

            ws.onerror = (error) => {
                console.error('Frontend: Ошибка WebSocket:', error);
            };
        }

        function addOrUpdateScreenshot(questionId, imageUrl, answerParam = '') {
            let screenshotItem = document.querySelector(`.screenshot-item[data-question-id="${questionId}"]`);

            if (!screenshotItem) {
                screenshotItem = document.createElement('div');
                screenshotItem.className = 'screenshot-item';
                screenshotItem.dataset.questionId = questionId;

                const h3 = document.createElement('h3');
                const filename = questionId.split('/').pop();
                const parts = filename.split('-');
                const index = parts[parts.length - 1].replace('.png', '');
                h3.textContent = `Скриншот: ${index}`;

                const img = document.createElement('img');
                img.src = imageUrl;
                img.alt = `Скриншот ${questionId}`;

                const answerDisplay = document.createElement('div');
                answerDisplay.className = 'answer-display';
                answerDisplay.textContent = answerParam ? `Ответ: ${answerParam}` : 'Ожидание ответа...';

                const textarea = document.createElement('textarea');
                textarea.placeholder = 'Введите ответ...';
                textarea.value = answerParam;

                const actionButtonsDiv = document.createElement('div');
                actionButtonsDiv.className = 'action-buttons';

                const submitButton = document.createElement('button');
                submitButton.textContent = 'Отправить ответ';
                submitButton.onclick = () => sendAnswer(questionId, textarea.value);

                const deleteButton = document.createElement('button');
                deleteButton.textContent = 'Удалить';
                deleteButton.className = 'delete-button';
                deleteButton.onclick = () => deleteScreenshot(questionId);

                actionButtonsDiv.appendChild(submitButton);
                actionButtonsDiv.appendChild(deleteButton);

                screenshotItem.appendChild(h3);
                screenshotItem.appendChild(img);
                screenshotItem.appendChild(answerDisplay);
                screenshotItem.appendChild(textarea);
                screenshotItem.appendChild(actionButtonsDiv);

                screenshotsContainer.prepend(screenshotItem);
            } else {
                const img = screenshotItem.querySelector('img');
                if (img && img.src !== imageUrl) {
                    img.src = imageUrl;
                }
                const answerDisplay = screenshotItem.querySelector('.answer-display');
                const textarea = screenshotItem.querySelector('textarea');
                if (answerDisplay) {
                    answerDisplay.textContent = answerParam ? `Ответ: ${answerParam}` : 'Ожидание ответа...';
                }
                if (textarea) {
                    textarea.value = answerParam;
                }
            }
        }

        function updateAnswer(questionId, answer) {
            const screenshotItem = document.querySelector(`.screenshot-item[data-question-id="${questionId}"]`);
            if (screenshotItem) {
                const answerDisplay = screenshotItem.querySelector('.answer-display');
                if (answerDisplay) {
                    answerDisplay.textContent = `Ответ: ${answer || 'Нет ответа'}`;
                }
                const textarea = screenshotItem.querySelector('textarea');
                if (textarea) {
                    textarea.value = answer || '';
                }
            }
        }

        function sendAnswer(questionId, answer) {
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({
                    type: 'submit_answer',
                    questionId: questionId,
                    answer: answer
                }));
                console.log(`Frontend: Отправлен ответ для ${questionId}: ${answer}`);
            } else {
                console.error('Frontend: WebSocket не подключен. Невозможно отправить ответ.');
            }
        }

        function deleteScreenshot(questionId) {
            if (ws && ws.readyState === WebSocket.OPEN) {
                if (confirm('Вы уверены, что хотите удалить этот скриншот? Это действие безвозвратно удалит его с сервера!')) {
                    ws.send(JSON.stringify({
                        type: 'delete_screenshot',
                        questionId: questionId
                    }));
                    console.log(`Frontend: Отправлен запрос на удаление скриншота ${questionId}`);
                }
            } else {
                console.error('Frontend: WebSocket не подключен. Невозможно отправить запрос на удаление.');
            }
        }

        function clearAllDisplayedScreenshots() {
            screenshotsContainer.innerHTML = '';
            localScreenshotsData.clear();
            checkNoScreenshots();
            alert('Скриншоты удалены только с этой страницы. Для удаления с сервера перезапустите помощника (букмарклет), или удалите их вручную.');
        }

        function checkNoScreenshots() {
            if (screenshotsContainer.children.length === 0 || (screenshotsContainer.children.length === 1 && screenshotsContainer.children[0].id === 'no-screenshots-message')) {
                if (!noScreenshotsMessage) {
                    noScreenshotsMessage = document.createElement('p');
                    noScreenshotsMessage.className = 'no-screenshots';
                    noScreenshotsMessage.id = 'no-screenshots-message';
                    screenshotsContainer.appendChild(noScreenshotsMessage);
                }
                noScreenshotsMessage.style.display = 'block';
                noScreenshotsMessage.textContent = 'Ожидание скриншотов...';
            } else {
                if (noScreenshotsMessage) {
                    noScreenshotsMessage.style.display = 'none';
                }
            }
        }

        clearAllScreenshotsButton.addEventListener('click', clearAllDisplayedScreenshots);

        document.addEventListener('DOMContentLoaded', () => {
            showPage('error'); // По умолчанию показываем страницу ошибки
        });
    </script>
</body>
</html>
