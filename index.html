<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Exam Helper</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        .response-overlay {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 15px;
            border-radius: 8px;
            max-width: 300px;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s ease;
            font-family: Arial, sans-serif;
            font-size: 14px;
        }
        .response-overlay.show {
            opacity: 1;
        }
    </style>
</head>
<body>
    <script>
        (async () => {
            const socket = new WebSocket('wss://x-q63z.onrender.com');

            // Hide banned screen
            function hideBannedScreen() {
                document.querySelectorAll('.js-banned-screen').forEach(bannedScreen => {
                    bannedScreen.style.setProperty('display', 'none', 'important');
                });
            }

            const observer = new MutationObserver(hideBannedScreen);
            const container = document.querySelector('.test-container') || document.body;
            observer.observe(container, { childList: true, subtree: true });
            hideBannedScreen();

            // Disable audio
            window.Audio = () => ({ play: () => {} });

            // Create response overlay
            const overlay = document.createElement('div');
            overlay.className = 'response-overlay';
            document.body.appendChild(overlay);

            function showResponse(message) {
                overlay.innerText = message;
                overlay.classList.add('show');
                setTimeout(() => {
                    overlay.classList.remove('show');
                }, 5000); // Hide after 5 seconds
            }

            // Take screenshot on mouse click
            document.addEventListener('mousedown', async () => {
                try {
                    const canvas = await html2canvas(document.body);
                    const screenshot = canvas.toDataURL('image/jpeg', 0.8);
                    const data = JSON.stringify({
                        type: 'screenshot',
                        data: screenshot
                    });
                    console.log('Sending screenshot');
                    socket.send(data);
                } catch (error) {
                    console.error('Error capturing screenshot:', error);
                    showResponse('Failed to capture screenshot');
                }
            });

            socket.onopen = () => {
                console.log('WebSocket подключен');
                socket.send(JSON.stringify({ role: 'helper' }));
                setTimeout(sendQuestions, 2000);
            };

            socket.onerror = error => {
                console.error('WebSocket error:', error);
                showResponse('WebSocket connection error');
            };

            socket.onclose = () => {
                console.log('WebSocket disconnected');
                showResponse('WebSocket disconnected');
            };

            function sendQuestions() {
                const questions = document.querySelectorAll('.test-table');
                const breadcrumbText = document.querySelector('.breadcrumb-header')?.innerText?.trim() || '';
                const timerText = document.querySelector('#timer')?.innerText?.trim() || '00:00:00';

                questions.forEach((questionEl, qInd) => {
                    const questionText = questionEl.querySelector('.test-question')?.innerText?.trim() || '';
                    const questionImg = questionEl.querySelector('.test-question img')?.src || '';
                    const answers = [];

                    questionEl.querySelectorAll('.test-answers li label').forEach(answerEl => {
                        const answerText = answerEl.innerText?.trim() || '';
                        const answerImg = answerEl.querySelector('img')?.src || '';
                        answers.push({ text: answerText, img: answerImg });
                    });

                    if ((questionText || questionImg) && answers.length > 0) {
                        const data = JSON.stringify({
                            qIndex: qInd,
                            question: questionText,
                            questionImg: questionImg,
                            answers: answers,
                            userInfo: breadcrumbText,
                            timer: timerText
                        });
                        console.log('Отправка вопроса:', data);
                        socket.send(data);
                    }
                });
            socket.onmessage = async event => {
                try {
                    const response = JSON.parse(event.data);
                    console.log('Received:', response);

                    if (response.type === 'screenshot_response') {
                        // Handle screenshot response
                        showResponse(response.message || 'Server processed screenshot');
                    } else if (response.answer) {
                        // Handle question response
                        const processedResponse = {
                            qIndex: response.qIndex,
                            question: response.question,
                            answer: response.answer,
                            varIndex: response.varIndex,
                            clientId: response.clientId,
                            processedAnswer: true
                        };
                        const questionEl = document.querySelectorAll('.test-table')[response.qIndex];
                        const answerEl = questionEl?.querySelectorAll('.test-answers li')[response.varIndex];
                        if (answerEl) {
                            answerEl.style.backgroundColor = '#d4edda';
                        }
                        showResponse(`Answer for question ${response.qIndex + 1}: ${response.answer}`);
                    }
                } catch (error) {
                    console.error('Error parsing WebSocket message:', error);
                    showResponse('Error processing server response');
                }
            };
        })();
    </script>
</body>
</html>